var AudioContextStarted=!1;$(document).ready(function(){isMobile()?(StartAudioContext(Tone.context,$("body"),function(){}),document.ontouchmove=function(e){e.preventDefault()}):document.querySelector("div").addEventListener("click",function(){"running"!==Tone.context.state&&Tone.context.resume().then(()=>{console.log("Playback resumed successfully")})})});
Array.prototype.rotate=function(e){for(;e--;){var t=this.shift();this.push(t)}return this},Array.prototype.remove=function(e){e=this.indexOf(e);return this.splice(e,1),this},Array.prototype.last=function(){return this[this.length-1]};const NOTE_NAMES="C C# Db D D# Eb E F F# Gb G G# Ab A A# Bb B".split(" "),NOTES=NOTE_NAMES.filter(e=>!e.includes("#")&&!e.includes("b")),SHARPS=NOTE_NAMES.filter(e=>e.includes("#")||!e.includes("b")),FLATS=NOTE_NAMES.filter(e=>e.includes("b")||!e.includes("#"));function NoteTokenize(t){if("string"==typeof t){t=/\b([A-G]|[a-g])(#|b|)([0-9]|10|11|)\b/g.exec(t);if(t){var n=t[1]+t[2];let e=parseInt(t[3]);return[n,e=isNaN(e)?null:e]}}return null}function NoteInterval(e,t="C"){let n;return n=SHARPS.includes(t)?SHARPS.indexOf(t):FLATS.includes(t)?FLATS.indexOf(t):0,SHARPS.includes(e)?SHARPS.rotate(n).indexOf(e):FLATS.includes(e)?FLATS.rotate(n).indexOf(e):(console.log(e,n),null)}function NoteToMidi(e){var t;return"string"==typeof e?null===(t=NoteTokenize(e))?null:12*(t[1]+1)+NoteInterval(t[0])-24:"number"==typeof e?e:void 0}function NoteFromMidi(e){if("number"==typeof e)return SHARPS[e%12]+(parseInt(e/12)+1).toString()}function NoteFreq(e,t=440){let n;if("string"==typeof e){if(null===(n=NoteToMidi(e)))return null}else{if("number"!=typeof e)return null;n=e}return+(t/32*Math.pow(2,(n-9)/12)).toFixed(2)}function NoteIntervalToName(e,t="C",n="#"){let i=NoteInterval(t);function o(e){e=(e+i)%12;return("#"==n?SHARPS:FLATS)[e]}switch(e.constructor){case Number:return o(e);case Array:return e.map(e=>o(e));default:return null}}const SCALES=new Object;function buildScale(e,t=1){var n=SCALES[e].definition.slice(),i=new Array,o=new Array,r=(n.length+SCALES[e].rootRepeat)*t;1==SCALES[e].rootRepeat&&(n.push(12),o.push(n.length));for(let e=0;e<r;e++)i.push(n[e%n.length]+12*parseInt(e/n.length));return{name:e,definition:n,intervals:i,repeat:o}}SCALES.major={definition:[0,2,4,5,7,9,11],rootRepeat:!0},SCALES.minor={definition:[0,2,3,5,7,8,10],rootRepeat:!0},SCALES.minor_harmonic={definition:[0,2,3,5,7,8,11],rootRepeat:!0},SCALES.gipsy={definition:[0,2,3,6,7,8,11],rootRepeat:!0},SCALES.pentatonic={definition:[0,2,5,7,9],rootRepeat:!1},SCALES.minor_melodic_asc={definition:[0,2,3,5,7,9,11],rootRepeat:!0},SCALES.minor_melodic_desc={definition:[0,2,3,5,7,8,10],rootRepeat:!0},SCALES.octatonic={definition:[0,1,3,4,6,7,9,10],rootRepeat:!1},SCALES.chromatic={definition:[0,1,2,3,4,5,6,7,8,9,10,11],rootRepeat:!1};
class Instrument{constructor(t,e,s){this.local=s||!1,this.socket=e,this.triggeredNotes=new Array,t&&this.loadPreset(t)}loadPreset(presetName){this.name=presetName,this.filePath="instruments/"+presetName+".json",$.getJSON(this.filePath,data=>{this.instance=eval(data.instance),this.polyphony=data.polyphony,1==this.polyphony?this.monophonic=!0:this.monophonic=!1,this.options=data.options}).then(()=>{1==this.monophonic?this.inst=new this.instance(this.options):(this.inst=new Tone.PolySynth(this.polyphony,this.instance),this.inst.set(this.options)),this.inst.toMaster()})}triggerAttack(t,e=!0,s=!1,i=void 0){this.inst&&(1==this.polyphony?(0<this.triggeredNotes.length||!0===e)&&(this.inst.triggerAttack(t,null,i),-1==this.triggeredNotes.indexOf(t)&&0==s&&this.triggeredNotes.push(t),!0===this.local)&&this.socket.emit("note_on",t):(!0===e||!0===s&&0<this.triggeredNotes.length)&&(!0!==s&&this.triggeredNotes.push(t),this.inst.triggerAttack(t,null,i),!0===this.local)&&this.socket.emit("note_on",t))}triggerRelease(t){this.inst&&(1==this.monophonic?(this.triggeredNotes.remove(t),0==this.triggeredNotes.length?this.inst.triggerRelease():this.triggerAttack(this.triggeredNotes.last())):(0<this.triggeredNotes.length&&this.triggeredNotes.remove(t),this.inst.triggerRelease(t)),!0===this.local)&&this.socket.emit("note_off",t)}releaseAll(){this.inst&&(1==this.monophonic?this.inst.triggerRelease():this.inst.releaseAll(),!(this.triggeredNotes.length=0)===this.local)&&this.socket.emit("release_all")}noteLeave(t){this.inst&&(0==this.monophonic&&this.inst.triggerRelease(t),!0===this.local)&&this.socket.emit("note_off",t)}setVolume(t){"number"!=typeof t||0<t||(this.inst.volume.value=t)}volumeUp(){this.setVolume(this.inst.volume.value+1)}volumeDown(){this.setVolume(this.inst.volume.value-1)}}
class Interface{constructor(t,e,i,s){this.socket=e,this.id="#"+e.id,this.players=i,this.instrument=this.players[e.id].instrument,this.parent=t||"#interface",this.context=s,this.setPalette(.5,128,127,12,40)}buildAndBindAll(){this.build(),this.bindMouseAndTouch(),this.bindKeyboard()}setPalette(t,e,i,s,r){r=r||20,this.colorPaletteOn=makeColorPalette(t,e,i,s),this.colorPaletteOff=makeColorPalette(t,e+r,i-r,s)}setupJam(t){this.jam=t,this.scale=buildScale(this.jam.global.scale,this.jam.local.octaveRange),this.buildAndBindAll(),this.instrument.releaseAll()}noteOn(t,e=!0,i=!1,s=1){if(console.log(this.context.state),"running"===this.context.state)try{(1==this.instrument.polyphony||this.instrument.triggeredNotes.length<this.instrument.polyphony)&&(0<this.instrument.triggeredNotes.length||!0===e)&&-1!=this.scale.intervals.indexOf(NoteInterval(NoteTokenize(t)[0],this.jam.global.rootNote))&&($(this.id+" [note='"+t+"']").css("background-color",this.colorPaletteOn[NoteInterval(t.replace(/\d+/g,""))]),this.instrument.triggerAttack(t,e,i,s))}catch(t){console.log(t)}}noteOff(t,e=!1){try{(0<this.instrument.triggeredNotes.length||1==e)&&this.instrument.triggerRelease(t)}catch(t){console.log(t)}$(this.id+" [note='"+t+"']").css("background-color",this.colorPaletteOff[NoteInterval(t.replace(/\d+/g,""))])}noteLeave(t){try{this.instrument.noteLeave(t)}catch(t){console.log(t)}}bindMouseAndTouch(){$(this.id+" [trigger=true]").on("pointerdown",t=>{this.noteOn($(t.currentTarget).attr("note"))}),$(this.id+" [trigger=true]").on("pointerup",t=>{this.noteOff($(t.currentTarget).attr("note"))}),$(this.id+" [trigger=true]").on("pointerenter",t=>{this.noteOn($(t.currentTarget).attr("note"),!1,!0)}),$(this.id+" [trigger=true]").on("pointerleave",t=>{t=$(t.currentTarget).attr("note");this.noteLeave(t),$(this.id+" [note='"+t+"']").css("background-color",this.colorPaletteOff[NoteInterval(t.replace(/\d+/g,""))])}),$("#header").on("pointerup",()=>{this.instrument.releaseAll()})}bindSockets(){this.socket.on("note_on",t=>{$(this.id+" [note='"+t.note+"'] > [client_id="+t.id+"]").addClass("o-1");try{1==this.players[t.id].play&&this.players[t.id].instrument&&this.players[t.id].instrument.triggerAttack(t.note,!0,!1)}catch(t){console.log(t)}}),this.socket.on("note_off",t=>{$(this.id+" [note='"+t.note+"'] > [client_id="+t.id+"]").removeClass("o-1");try{this.players[t.id].play&&this.players[t.id].instrument&&this.players[t.id].instrument.triggerRelease(t.note)}catch(t){console.log(t)}}),this.socket.on("release_all",t=>{$(this.id+" [trigger=true] > [client_id="+t.id+"]").removeClass("o-1")}),this.socket.on("disconnect",()=>{this.removeAllPlayers(),alert("Server disconnected... you are now playing by yourself")})}}class PadsInterface extends Interface{build(){$(this.parent).html($("<div/>").addClass("block").attr({id:this.socket.id})),this.scale.intervals.forEach((t,e)=>{var i=this.jam.local.rootOctave+parseInt((t+NoteInterval(this.jam.global.rootNote))/12),s=(t+NoteInterval(this.jam.global.rootNote))%12,i=NoteIntervalToName(t,this.jam.global.rootNote)+i;$(this.id).append($("<div/>").addClass("pad"+(-1!=this.scale.repeat.indexOf(e)||this.scale.intervals.indexOf(t)==this.scale.intervals.length-1?" repeat":"")).css("background-color",this.colorPaletteOff[s]).attr({note:i,trigger:!0,"touch-action":"none"}).html($("<div/>").text(this.jam.global.showNotes?i:"").addClass("pad-note")))}),Object.keys(this.players).forEach(t=>{$(this.id+" [trigger=true]").append($("<div/>").attr({client_id:t}).addClass("mini-pad"))})}addPlayer(t){$(this.id+" [trigger=true]").append($("<div/>").attr({client_id:t}).addClass("mini-pad"))}removePlayer(t){$(this.id+" [client_id="+t+"]").remove()}removeAllPlayers(){console.log("remove all players.."),$(this.id+" .mini-pad").remove()}unbindKeyboard(){KEYS_PAD.forEach(t=>{Mousetrap.unbind(t,"keydown"),Mousetrap.unbind(t,"keyup")})}bindKeyboard(){this.unbindKeyboard(),$(this.id+" [trigger=true]").each((t,e)=>{Mousetrap.bind(KEYS_PAD[t],t=>{0!=t.repeat&&void 0!==t.repeat||this.noteOn($(e).attr("note"))},"keydown"),Mousetrap.bind(KEYS_PAD[t],()=>{this.noteOff($(e).attr("note"))},"keyup")}),Object.keys(ACCESSIBLE_KEYS).forEach(e=>{Mousetrap.bind(e,t=>{t.preventDefault?t.preventDefault():t.returnValue=!1,0==t.repeat&&Mousetrap.trigger(ACCESSIBLE_KEYS[e],"keydown")},"keydown"),Mousetrap.bind(e,()=>{Mousetrap.trigger(ACCESSIBLE_KEYS[e],"keyup")},"keyup")})}}
function makeColorPalette(e,t,o,a){function l(e){var t="0123456789ABCDEF";return String(t.substr(e>>4&15,1))+t.substr(15&e,1)}e=e||.52,t=t||128,o=o||127,a=a||12;for(var s=new Array,c=0;c<a;++c){var n=Math.sin(e*c+0)*o+t,i=Math.sin(e*c+2)*o+t,h=Math.sin(e*c+4)*o+t;s.push((i=i,h=h,"#"+l(n)+l(i)+l(h)))}return s}function toggleFullScreen(){var e=window.document,t=e.documentElement,o=t.requestFullscreen||t.mozRequestFullScreen||t.webkitRequestFullScreen||t.msRequestFullscreen,a=e.exitFullscreen||e.mozCancelFullScreen||e.webkitExitFullscreen||e.msExitFullscreen;e.fullscreenElement||e.mozFullScreenElement||e.webkitFullscreenElement||e.msFullscreenElement?a.call(e):o.call(t)}const KEYS_PAD=["z","x","c","v","b","n","m",",","a","s","d","f","g","h","j","k","w","e","r","t","y","u","i","o","2","3","4","5","6","7","8","9"],ACCESSIBLE_KEYS={space:"a",enter:"d",tab:"g","shift+tab":"j",backspace:"k"},INSTRUMENTS={"Polyphonic Sine":"poly_sine"};class EchoPlay{constructor(e,t){this.context=e,this.socket=io.connect(),this.parent=t||"#interface",this.jam={local:{maestro:!0,rootOctave:3,octaveRange:2,instrumentPreset:Object.values(INSTRUMENTS)[Math.floor(Math.random()*Object.values(INSTRUMENTS).length)]},global:{rootNote:["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"][Math.floor(12*Math.random())],scale:["major","minor","minor_harmonic","gipsy"][Math.floor(4*Math.random())],showNotes:!0}},this.players=new Object,this.socket.on("connect",()=>{this.socket.emit("instrument_preset",this.jam.local.instrumentPreset),this.addPlayer(this.socket.id,this.socket,!0,this.jam.local.instrumentPreset),this.interface=new PadsInterface(this.parent,this.socket,this.players,this.context),this.setupSocket(),this.socket.emit("get_players")}),this.displaySettings=!1}setupSocket(){this.socket.on("url",e=>{$("#url").text(e)}),this.socket.on("new_jam",e=>{this.jam.global=e,this.render()}),this.socket.on("share_locals",e=>{this.jam.local=e,this.render()}),this.socket.on("players",(e,t)=>{console.log("players received"),console.log(t),e.forEach(e=>{console.log("player:",e,t[e]),-1==Object.keys(this.players).indexOf(e)&&this.addPlayer(e,this.socket,!1,t[e])}),1==this.displaySettings&&this.renderSettings()}),this.socket.on("add_player",(e,t)=>{console.log("add player:",e,t),this.addPlayer(e,this.socket,!1,t),1==this.displaySettings&&this.renderSettings()}),this.socket.on("remove_player",e=>{console.log("remove player:",e),this.removePlayer(e),1==this.displaySettings&&this.renderSettings()}),this.socket.on("load_instrument",(e,t)=>{console.log("load_instrument",e,t,e==this.socket.id),this.players[e]&&(console.log("loading preset"),this.players[e].instrument.loadPreset(t))}),this.socket.emit("request_jam"),this.interface.bindSockets()}toggleSettings(){this.displaySettings=!this.displaySettings,this.render()}renderSettings(){$(this.parent).html("<div id='settings'>       <h1>Settings</h1>       <h2>Jammers</h2>       <div id='jammers'/>       <h2>We're jamming in:</h2>       <p>"+this.jam.global.rootNote+" "+this.jam.global.scale+"</p>     </div>"),Object.keys(this.players).forEach(t=>{$("#jammers").append($("<div/>").attr({player_id:t}).click(e=>{this.players[t].play=!this.players[t].play,1==this.players[t].play?$(e.target).css("color","#00FF00"):$(e.target).css("color","#FF0000")}).text(t+" / "+this.players[t].instrument.name+" / "+this.players[t].play))})}render(){1==this.displaySettings?this.renderSettings():this.interface.setupJam(this.jam)}setRootOctave(e,t=!1,o){this.jam.local.rootOctave=e,this.render(),!0===t&&!0===this.jam.local.maestro&&this.socket.emit("share_locals",this.jam.local)}setOctaveRange(e,t=!1){"number"==typeof e&&(e<1?e=1:10<e&&(e=10),this.jam.local.octaveRange=e,this.render(),!0===t)&&!0===this.jam.local.maestro&&this.socket.emit("share_locals",this.jam.local)}setRootNote(e,t=0){-1!=NOTE_NAMES.indexOf(e)&&!0===this.jam.local.maestro&&(this.jam.global.rootNote=e,this.socket.emit("update_jam",this.jam.global))}setScale(e){-1!=Object.keys(SCALES).indexOf(e)&&!0===this.jam.local.maestro&&(this.jam.global.scale=e,this.socket.emit("update_jam",this.jam.global))}addPlayer(e,t,o,a){t=self.socket||t,o=o||!1,!(this.players[e]={instrument:new Instrument(a,t,o),play:!0})===o&&this.interface.addPlayer(e)}removePlayer(e){this.interface.removePlayer(e);try{this.players[e].instrument.inst.dispose(),console.log("disposed of instrument "+e)}catch(e){console.log(e)}delete this.players[e]}}$(document).ready(function(){Tone.context.latencyHint="fastest",echoplay=new EchoPlay(Tone.context);var e={"alt+a":function(){echoplay.setRootNote("A")},"alt+b":function(){echoplay.setRootNote("B")},"alt+c":function(){echoplay.setRootNote("C")},"alt+d":function(){echoplay.setRootNote("D")},"alt+e":function(){echoplay.setRootNote("E")},"alt+f":function(){echoplay.setRootNote("F")},"alt+g":function(){echoplay.setRootNote("G")},"alt+right":function(){"B"==echoplay.jam.global.rootNote&&echoplay.setRootOctave(echoplay.jam.local.rootOctave+1,!0),echoplay.setRootNote(SHARPS[(SHARPS.indexOf(echoplay.jam.global.rootNote)+1)%SHARPS.length])},"alt+left":function(){let e;e="C"==echoplay.jam.global.rootNote?(echoplay.setRootOctave(echoplay.jam.local.rootOctave-1,!0),"B"):SHARPS[(SHARPS.indexOf(echoplay.jam.global.rootNote)-1)%SHARPS.length],echoplay.setRootNote(e)},"alt+r k":function(){echoplay.setRootNote(SHARPS[Math.floor(12*Math.random())])},"alt+up":function(){echoplay.setRootOctave(echoplay.jam.local.rootOctave+1,!0)},"alt+down":function(){echoplay.setRootOctave(echoplay.jam.local.rootOctave-1,!0)},"alt+shift+up":function(){echoplay.setOctaveRange(echoplay.jam.local.octaveRange+1,!0)},"alt+shift+down":function(){echoplay.setOctaveRange(echoplay.jam.local.octaveRange-1,!0)},"alt+shift+right":function(){var e=Object.keys(SCALES)[(Object.keys(SCALES).indexOf(echoplay.jam.global.scale)+1)%Object.keys(SCALES).length];echoplay.setScale(e)},"alt+shift+left":function(){var e=Object.keys(SCALES);let t;t=echoplay.jam.global.scale==e[0]?e[e.length-1]:e[(e.indexOf(echoplay.jam.global.scale)-1)%e.length],echoplay.setScale(t)},"alt+r s":function(){echoplay.setScale(Object.keys(SCALES)[Math.floor(Math.random()*Object.keys(SCALES).length)])},"alt+0":function(){echoplay.setScale("chromatic")},"alt+1":function(){echoplay.setScale("major")},"alt+2":function(){echoplay.setScale("minor")},"alt+3":function(){echoplay.setScale("minor_harmonic")},"alt+4":function(){echoplay.setScale("gipsy")},"alt+5":function(){echoplay.setScale("pentatonic")},"alt+6":function(){echoplay.setScale("minor_melodic_asc")},"alt+7":function(){echoplay.setScale("minor_melodic_desc")},"alt+8":function(){echoplay.setScale("octatonic")},"alt+n":function(){echoplay.jam.local.maestro&&echoplay.socket.emit("show_note_names",!0)},"alt+shift+n":function(){echoplay.jam.local.maestro&&echoplay.socket.emit("show_note_names",!1)}};Mousetrap.bind({"meta+up":function(){echoplay.setRootOctave(echoplay.jam.local.rootOctave+1)},"meta+down":function(){echoplay.setRootOctave(echoplay.jam.local.rootOctave-1)},"meta+shift+up":function(){echoplay.setOctaveRange(echoplay.jam.local.octaveRange+1)},"meta+shift+down":function(){echoplay.setOctaveRange(echoplay.jam.local.octaveRange-1)},"mod+.":function(){echoplay.interface.instrument.volumeUp()},"mod+,":function(){echoplay.interface.instrument.volumeDown()},f1:function(){toggleFullScreen()}}),!0===echoplay.jam.local.maestro&&Mousetrap.bind(e),$("h1").click(function(){echoplay.toggleSettings()})});
var midi=null,MIDIDevices=new Object;function onMIDISuccess(e){for(var a of(midi=e).inputs){a=a[1];MIDIDevices[a.id]=a,MIDIDevices[a.id].onmidimessage=function(e){var a,i;144!=e.data[0]&&128!=e.data[0]||(a=NoteFromMidi(e.data[1]),i=e.data[2]/127,0==e.data[2]?echoplay.interface.noteOff(a,!0):echoplay.interface.noteOn(a,!0,!1,i))}}}function onMIDIFailure(e){console.log("Failed to get MIDI access - "+e)}navigator.requestMIDIAccess().then(onMIDISuccess,onMIDIFailure);